

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ml.engine &mdash; ml 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            ml
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../engine_api.html">Engine API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../parts_api.html">Parts API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../event_sources_api.html">Event Sources API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../strategies_api.html">Strategies API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tracer_api.html">Tracer API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ml</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">ml.engine</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ml.engine</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Deque</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ml</span><span class="w"> </span><span class="kn">import</span> <span class="n">data</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">deque</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.tracer</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tracer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.enums</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogLevel</span><span class="p">,</span> <span class="n">QueueMode</span><span class="p">,</span> <span class="n">OnFullBehavior</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">conf</span> <span class="k">as</span> <span class="n">ml_conf</span>

<div class="viewcode-block" id="Port">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Port">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Port</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents an input or output port for a Part.&quot;&quot;&quot;</span>
    <span class="n">IN</span> <span class="o">=</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">DIRECTION_IN</span>
    <span class="n">OUT</span> <span class="o">=</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">DIRECTION_OUT</span>
    <span class="c1"># A type hint for a parent object that has a &#39;full_identifier&#39; attribute.</span>
    <span class="n">Parent</span> <span class="o">=</span> <span class="n">Any</span>

<div class="viewcode-block" id="Port.OverwriteError">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Port.OverwriteError">[docs]</a>
    <span class="k">class</span><span class="w"> </span><span class="nc">OverwriteError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Exception raised when set() is called on an already updated Port.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="Port.StaleReadError">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Port.StaleReadError">[docs]</a>
    <span class="k">class</span><span class="w"> </span><span class="nc">StaleReadError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Exception raised when get() is called on a port that has not been updated.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes a Port.</span>

<span class="sd">        Args:</span>
<span class="sd">            identifier: The name of the port.</span>
<span class="sd">            direction: The direction, either Port.IN or Port.OUT.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__identifier</span> <span class="o">=</span> <span class="n">identifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__direction</span> <span class="o">=</span> <span class="n">direction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__full_identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__identifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Port</span><span class="o">.</span><span class="n">Parent</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__payload</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__updated</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__connected_as_slave</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Creation logging is now handled by the parent Part&#39;s _log_creation_cascade.</span>

<div class="viewcode-block" id="Port.get_identifier">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Port.get_identifier">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the local identifier of the port.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The local identifier of the port.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__identifier</span></div>


<div class="viewcode-block" id="Port.get_direction">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Port.get_direction">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_direction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the direction of the port.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The direction of the port (e.g., &#39;input&#39; or &#39;output&#39;).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__direction</span></div>


<div class="viewcode-block" id="Port.get_full_identifier">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Port.get_full_identifier">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_full_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the fully qualified identifier of the port.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The fully qualified identifier, including parent hierarchy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__full_identifier</span></div>


<div class="viewcode-block" id="Port.get_parent">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Port.get_parent">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Parent</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the parent component of the port.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[Parent]: The parent object (typically a Part), or None if not set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parent</span></div>


<div class="viewcode-block" id="Port.get">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Port.get">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the payload from the port. This is a non-destructive read;</span>
<span class="sd">        the &#39;updated&#39; flag is cleared by the engine after the owning part&#39;s</span>
<span class="sd">        `execute()` method has completed for the current step.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any: The payload currently held by the port.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_updated</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">Port</span><span class="o">.</span><span class="n">StaleReadError</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">ERROR_PORT_STALE_READ</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">()))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__payload</span></div>


<div class="viewcode-block" id="Port.peek">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Port.peek">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">peek</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the payload from the port without checking the &#39;updated&#39; flag.</span>
<span class="sd">        This is a non-destructive read intended for monitoring or debugging from</span>
<span class="sd">        outside the synchronous dataflow execution.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any: The payload currently held by the port.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># This bypasses the is_updated() check for external polling.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__payload</span></div>


<div class="viewcode-block" id="Port.is_updated">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Port.is_updated">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_updated</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if the port&#39;s payload has been updated since the last clear.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the port holds new data, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__updated</span></div>


<div class="viewcode-block" id="Port.set">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Port.set">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the payload of the port and marks it as updated.</span>
<span class="sd">        </span>
<span class="sd">        This method is called by the framework during data transfers and should</span>
<span class="sd">        be called by the user inside a `behavior()` method to set the value of</span>
<span class="sd">        an output port.</span>

<span class="sd">        Args:</span>
<span class="sd">            payload: The new payload for the port.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_updated</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">Port</span><span class="o">.</span><span class="n">OverwriteError</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">ERROR_PORT_OVERWRITE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__payload</span> <span class="o">=</span> <span class="n">payload</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__updated</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_DATAFLOW</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_SET_PAYLOAD</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;payload&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__payload</span><span class="p">})</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_clear_update_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clears the port&#39;s updated flag.</span>

<span class="sd">        This method is called by the simulation engine after a</span>
<span class="sd">        part&#39;s `execute` or `__step` method has consumed the port&#39;s data,</span>
<span class="sd">        making it ready to receive a new payload.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_DATAFLOW</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_CLEAR_FLAG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__updated</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_connected_as_slave</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Marks the port as connected as a slave, ensuring it&#39;s only done once.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ConnectionError: If the port is already connected as a slave.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__connected_as_slave</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ConnectionError</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">ERROR_SLAVE_PORT_ALREADY_CONNECTED</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__connected_as_slave</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">Parent</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the parent component.</span>

<span class="sd">        This is called during the parent&#39;s initialization to establish the</span>
<span class="sd">        hierarchical structure and enable full identifier generation.</span>

<span class="sd">        Args:</span>
<span class="sd">            parent (Parent): The parent object (typically a Part).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parent</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># Parent already set.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_full_identifier</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_log_creation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Logs the creation of this component. Called after the full_identifier is finalized.&quot;&quot;&quot;</span>
        <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_CREATE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_CREATE</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;direction&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_direction</span><span class="p">()})</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">_update_full_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates the full identifier based on the parent&#39;s.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parent</span><span class="p">:</span>
            <span class="c1"># This uses the parent&#39;s public full_identifier attribute</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__full_identifier</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__parent</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">()</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_identifier</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span></div>



<div class="viewcode-block" id="EventQueue">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.EventQueue">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">EventQueue</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a queue for storing event payloads, with different behaviors</span>
<span class="sd">    for input and output directions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">IN</span> <span class="o">=</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">DIRECTION_IN</span>
    <span class="n">OUT</span> <span class="o">=</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">DIRECTION_OUT</span>
    <span class="c1"># A type hint for a parent object that has a &#39;full_identifier&#39; attribute.</span>
    <span class="n">Parent</span> <span class="o">=</span> <span class="n">Any</span>

<div class="viewcode-block" id="EventQueue.FullError">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.EventQueue.FullError">[docs]</a>
    <span class="k">class</span><span class="w"> </span><span class="nc">FullError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Exception raised when push() is called on a full EventQueue.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="EventQueue.EmptyError">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.EventQueue.EmptyError">[docs]</a>
    <span class="k">class</span><span class="w"> </span><span class="nc">EmptyError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Exception raised when pop() is called on an empty EventQueue.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">QueueMode</span> <span class="o">=</span> <span class="n">QueueMode</span><span class="o">.</span><span class="n">FIFO</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes an EventQueue.</span>

<span class="sd">        Args:</span>
<span class="sd">            identifier: The unique name of the event queue.</span>
<span class="sd">            direction: The direction, either EventQueue.IN or EventQueue.OUT.</span>
<span class="sd">            size: The maximum number of events for an IN queue. Must be None for OUT queues.</span>
<span class="sd">            mode: The queueing behavior, either FIFO (default) or LIFO.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">EventQueue</span><span class="o">.</span><span class="n">IN</span><span class="p">,</span> <span class="n">EventQueue</span><span class="o">.</span><span class="n">OUT</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">ERROR_INVALID_PORT_DIRECTION</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">direction</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__identifier</span> <span class="o">=</span> <span class="n">identifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__direction</span> <span class="o">=</span> <span class="n">direction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__full_identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__identifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EventQueue</span><span class="o">.</span><span class="n">Parent</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__mode</span> <span class="o">=</span> <span class="n">mode</span>

        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="n">EventQueue</span><span class="o">.</span><span class="n">OUT</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">ERROR_INVALID_QUEUE_SIZE_FOR_DIRECTION</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">direction</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__size</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># IN</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">ERROR_INVALID_QUEUE_SIZE</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__size</span> <span class="o">=</span> <span class="n">size</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__payload</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>      <span class="c1"># For OUT queues</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__payloads</span><span class="p">:</span> <span class="n">Deque</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>  <span class="c1"># For IN queues</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__event_interfaces</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">EventInterface</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__connected_as_slave</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__connected_as_master_in_to_in</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Creation logging is now handled by the parent&#39;s _log_creation_cascade or __init__.</span>

<div class="viewcode-block" id="EventQueue.get_identifier">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.EventQueue.get_identifier">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the local identifier of the event queue.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The local identifier of the event queue.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__identifier</span></div>


<div class="viewcode-block" id="EventQueue.get_direction">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.EventQueue.get_direction">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_direction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the direction of the event queue.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The direction of the event queue (e.g., &#39;input&#39; or &#39;output&#39;).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__direction</span></div>


<div class="viewcode-block" id="EventQueue.get_full_identifier">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.EventQueue.get_full_identifier">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_full_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the fully qualified identifier of the event queue.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The fully qualified identifier, including parent hierarchy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__full_identifier</span></div>


<div class="viewcode-block" id="EventQueue.push">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.EventQueue.push">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds an event payload to the queue based on its direction.</span>

<span class="sd">        Args:</span>
<span class="sd">            payload (Any): The event payload to add.</span>
<span class="sd">            overwrite (bool): For IN queues, if True, this will replace an</span>
<span class="sd">                              existing item if the queue is full.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_direction</span><span class="p">()</span> <span class="o">==</span> <span class="n">EventQueue</span><span class="o">.</span><span class="n">OUT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__payload</span> <span class="o">=</span> <span class="n">payload</span>
            <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_DATAFLOW</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_PUSH</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;payload&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">})</span>
            <span class="c1"># For output queues, immediately transfer the event to all connected interfaces.</span>
            <span class="k">for</span> <span class="n">interface</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__event_interfaces</span><span class="p">:</span>
                <span class="n">interface</span><span class="o">.</span><span class="n">_transfer</span><span class="p">(</span><span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_full</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
                    <span class="n">size_before</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__payloads</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mode</span> <span class="o">==</span> <span class="n">QueueMode</span><span class="o">.</span><span class="n">LIFO</span><span class="p">:</span>
                        <span class="n">removed_payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__payloads</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="c1"># Remove newest</span>
                    <span class="k">else</span><span class="p">:</span> <span class="c1"># FIFO</span>
                        <span class="n">removed_payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__payloads</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span> <span class="c1"># Remove oldest</span>
                    <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">LogLevel</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_OVERWRITE</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;removed&quot;</span><span class="p">:</span> <span class="n">removed_payload</span><span class="p">,</span> <span class="s2">&quot;added&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">})</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__payloads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
                    <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_DATAFLOW</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_PUSH</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;payload&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">,</span> <span class="s2">&quot;size_before&quot;</span><span class="p">:</span> <span class="n">size_before</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;size_after&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__payloads</span><span class="p">)})</span>
                    <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">EventQueue</span><span class="o">.</span><span class="n">FullError</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">ERROR_QUEUE_FULL_WITH_PAYLOAD</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">queue_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">()))</span>
            <span class="n">size_before</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__payloads</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__payloads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
            <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_DATAFLOW</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_PUSH</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;payload&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">,</span> <span class="s2">&quot;size_before&quot;</span><span class="p">:</span> <span class="n">size_before</span><span class="p">,</span> <span class="s2">&quot;size_after&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__payloads</span><span class="p">)})</span></div>


<div class="viewcode-block" id="EventQueue.peek">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.EventQueue.peek">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">peek</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the payload from an OUT queue without consuming it.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[Any]: The payload if the queue is an OUT queue and not empty,</span>
<span class="sd">                           otherwise None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_empty</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_direction</span><span class="p">()</span> <span class="o">!=</span> <span class="n">EventQueue</span><span class="o">.</span><span class="n">OUT</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_DATAFLOW</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_PEEK</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;payload&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__payload</span><span class="p">})</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__payload</span></div>


<div class="viewcode-block" id="EventQueue.is_empty">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.EventQueue.is_empty">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if the event queue is empty.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the queue has no items, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__payload</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_direction</span><span class="p">()</span> <span class="o">==</span> <span class="n">EventQueue</span><span class="o">.</span><span class="n">OUT</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__payloads</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="EventQueue.is_full">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.EventQueue.is_full">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_full</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if the event queue is full.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the queue has reached its capacity, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_empty</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_direction</span><span class="p">()</span> <span class="o">==</span> <span class="n">EventQueue</span><span class="o">.</span><span class="n">OUT</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__payloads</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__size</span></div>


<div class="viewcode-block" id="EventQueue.clear">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.EventQueue.clear">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Removes all event payloads from the queue.&quot;&quot;&quot;</span>
        <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_LIFECYCLE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_CLEAR</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_direction</span><span class="p">()</span> <span class="o">==</span> <span class="n">EventQueue</span><span class="o">.</span><span class="n">OUT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__payload</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__payloads</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>


<div class="viewcode-block" id="EventQueue.pop">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.EventQueue.pop">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes and returns an event payload from an IN queue.</span>

<span class="sd">        The item returned depends on the queue&#39;s mode (FIFO or LIFO).</span>
<span class="sd">        For OUT queues, this is a destructive read of the single payload.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[Any]: The payload removed from the queue.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">EventQueue</span><span class="o">.</span><span class="n">EmptyError</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">ERROR_QUEUE_EMPTY</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">()))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_direction</span><span class="p">()</span> <span class="o">==</span> <span class="n">EventQueue</span><span class="o">.</span><span class="n">OUT</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__payload</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__payload</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_DATAFLOW</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_POP</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;payload&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">payload</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">size_before</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__payloads</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mode</span> <span class="o">==</span> <span class="n">QueueMode</span><span class="o">.</span><span class="n">LIFO</span><span class="p">:</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__payloads</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># FIFO</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__payloads</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
            <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_DATAFLOW</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_POP</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;payload&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">,</span> <span class="s2">&quot;size_before&quot;</span><span class="p">:</span> <span class="n">size_before</span><span class="p">,</span> <span class="s2">&quot;size_after&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__payloads</span><span class="p">)})</span>
            <span class="k">return</span> <span class="n">payload</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_add_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interface</span><span class="p">:</span> <span class="n">EventInterface</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Registers a connecting interface.</span>

<span class="sd">        This is called by an `EventInterface` during its initialization to</span>
<span class="sd">        allow the master queue to trigger transfers.</span>

<span class="sd">        Args:</span>
<span class="sd">            interface (EventInterface): The interface to register.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__event_interfaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interface</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_connected_as_master</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Marks the queue as connected as a master, enforcing connection policies.</span>

<span class="sd">        Specifically, an IN-type queue can only be a master to one slave to</span>
<span class="sd">        ensure unambiguous event routing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># IN queues can only be master to one slave for clear routing.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_direction</span><span class="p">()</span> <span class="o">==</span> <span class="n">EventQueue</span><span class="o">.</span><span class="n">IN</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__connected_as_master_in_to_in</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ConnectionError</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">ERROR_IN_QUEUE_MASTER_ALREADY_CONNECTED</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__connected_as_master_in_to_in</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_connected_as_slave</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Marks the queue as connected as a slave, ensuring it&#39;s only done once.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ConnectionError: If the queue is already connected as a slave.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__connected_as_slave</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ConnectionError</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">ERROR_SLAVE_QUEUE_ALREADY_CONNECTED</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__connected_as_slave</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">Parent</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the parent component.</span>

<span class="sd">        This is called during the parent&#39;s initialization to establish the</span>
<span class="sd">        hierarchical structure and enable full identifier generation.</span>

<span class="sd">        Args:</span>
<span class="sd">            parent (Parent): The parent object (typically a Part or EventSource).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parent</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># Parent already set.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_full_identifier</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_log_creation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Logs the creation of this component. Called after the full_identifier is finalized.&quot;&quot;&quot;</span>
        <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_CREATE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_CREATE</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;direction&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_direction</span><span class="p">(),</span> <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__size</span><span class="p">})</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">_update_full_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates the full identifier based on the parent&#39;s.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parent</span><span class="p">:</span>
            <span class="c1"># This uses the parent&#39;s public full_identifier attribute</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__full_identifier</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__parent</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">()</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_identifier</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span></div>



<div class="viewcode-block" id="EventSource">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.EventSource">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">EventSource</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract base class for components that generate events, typically in a</span>
<span class="sd">    separate thread.</span>

<span class="sd">    This class provides the core infrastructure for starting, stopping, and</span>
<span class="sd">    managing the lifecycle of an event source thread. Subclasses must</span>
<span class="sd">    implement the `_run_loop` method, which contains the logic for generating</span>
<span class="sd">    events.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">on_full</span><span class="p">:</span> <span class="n">OnFullBehavior</span> <span class="o">=</span> <span class="n">OnFullBehavior</span><span class="o">.</span><span class="n">FAIL</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the EventSource.</span>

<span class="sd">        Args:</span>
<span class="sd">            identifier (str): The unique name for the event source.</span>
<span class="sd">            on_full (OnFullBehavior): The policy for handling a full target</span>
<span class="sd">                                      queue (FAIL, DROP, or OVERWRITE).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__identifier</span> <span class="o">=</span> <span class="n">identifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__full_identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__identifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__on_full_behavior</span> <span class="o">=</span> <span class="n">on_full</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__output_queue</span> <span class="o">=</span> <span class="n">EventQueue</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">DEFAULT_EVENT_SOURCE_OUT_QUEUE_ID</span><span class="p">,</span> <span class="n">EventQueue</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__output_queue</span><span class="o">.</span><span class="n">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># For a standalone EventSource, the name is final at creation, so we can log immediately.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__output_queue</span><span class="o">.</span><span class="n">_log_creation</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__part_wakeup_signal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__is_running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__exception</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="ne">Exception</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__stop_event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

<div class="viewcode-block" id="EventSource.get_identifier">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.EventSource.get_identifier">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the local identifier of the event source.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The local identifier of the event source.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__identifier</span></div>


<div class="viewcode-block" id="EventSource.get_full_identifier">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.EventSource.get_full_identifier">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_full_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the fully qualified identifier of the event source.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The fully qualified identifier.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__full_identifier</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_get_output_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EventQueue</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the single output queue for this event source.</span>

<span class="sd">        Returns:</span>
<span class="sd">            EventQueue: The internal output queue instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__output_queue</span>

<div class="viewcode-block" id="EventSource.get_exception">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.EventSource.get_exception">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="ne">Exception</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the exception that caused the run loop to terminate, if any.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[Exception]: The exception object if one occurred, otherwise None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__exception</span></div>


    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_run_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The main loop for the event source. This method must be implemented by</span>
<span class="sd">        subclasses.</span>

<span class="sd">        The loop should periodically check `self.is_running()` or</span>
<span class="sd">        `self.__stop_event.is_set()` and exit gracefully.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="EventSource.stop_event_is_set">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.EventSource.stop_event_is_set">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">stop_event_is_set</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if the stop event has been set.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the stop event is set, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__stop_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">()</span></div>


<div class="viewcode-block" id="EventSource.start">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.EventSource.start">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Starts the event source in a new thread.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__stop_event</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__exception</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__is_running</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">()</span><span class="si">}{</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">THREAD_NAME_SUFFIX</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The internal thread target that wraps the main loop with exception handling.&quot;&quot;&quot;</span>
        <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_LIFECYCLE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_LIFECYCLE_THREAD_START</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_loop</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1"># Catches all exceptions, including EventQueue.FullError</span>
            <span class="n">tb_str</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">LogLevel</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_EXCEPTION</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="s2">&quot;traceback&quot;</span><span class="p">:</span> <span class="n">tb_str</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__exception</span> <span class="o">=</span> <span class="n">e</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="c1"># The &#39;raise&#39; is removed to prevent the default traceback dump.</span>
            <span class="c1"># The exception is stored and can be retrieved by the main thread.</span>
        <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_LIFECYCLE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_LIFECYCLE_THREAD_END</span><span class="p">)</span>

<div class="viewcode-block" id="EventSource.stop">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.EventSource.stop">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stops the event source thread and signals any listeners.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_running</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_LIFECYCLE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_STOP_SIGNALLED</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__is_running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__stop_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__part_wakeup_signal</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__part_wakeup_signal</span><span class="o">.</span><span class="n">set</span><span class="p">()</span></div>


<div class="viewcode-block" id="EventSource.wait">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.EventSource.wait">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Waits for the event source thread to finish.&quot;&quot;&quot;</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Waits for the event source thread to finish.</span>

<span class="sd">        Args:</span>
<span class="sd">            timeout (Optional[float]): The maximum time in seconds to wait</span>
<span class="sd">                                       for the thread to complete.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="EventSource.is_running">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.EventSource.is_running">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_running</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if the event source thread is running.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the source is running, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_running</span></div>


<div class="viewcode-block" id="EventSource.emit">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.EventSource.emit">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Emits an event with a given payload.</span>

<span class="sd">        The output queue will handle the immediate transfer, and this</span>
<span class="sd">        method will signal any waiting Part. The output queue is cleared</span>
<span class="sd">        after the attempt, regardless of success.</span>

<span class="sd">        Args:</span>
<span class="sd">            payload (Any): The payload of the event to emit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Log the emission attempt, including the policy for handling a full queue.</span>
        <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_DATAFLOW</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_EMIT</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;payload&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">,</span> <span class="s2">&quot;on_full_policy&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__on_full_behavior</span><span class="o">.</span><span class="n">name</span><span class="p">})</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Determine if we should attempt to overwrite based on the policy.</span>
            <span class="n">should_overwrite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__on_full_behavior</span> <span class="o">==</span> <span class="n">OnFullBehavior</span><span class="o">.</span><span class="n">OVERWRITE</span>
            <span class="c1"># This push triggers the instantaneous transfer.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__output_queue</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">should_overwrite</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__part_wakeup_signal</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__part_wakeup_signal</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">EventQueue</span><span class="o">.</span><span class="n">FullError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__on_full_behavior</span> <span class="o">==</span> <span class="n">OnFullBehavior</span><span class="o">.</span><span class="n">DROP</span><span class="p">:</span>
                <span class="c1"># Policy is to drop the event. Log it and continue.</span>
                <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_LIFECYCLE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_EMIT_SKIPPED</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_DETAIL_REASON_TARGET_FULL</span><span class="p">,</span> <span class="s2">&quot;payload&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">})</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__on_full_behavior</span> <span class="o">==</span> <span class="n">OnFullBehavior</span><span class="o">.</span><span class="n">FAIL</span><span class="p">:</span>
                <span class="c1"># Policy is to fail. Propagate the exception up to the</span>
                <span class="c1"># run loop&#39;s main exception handler, which will stop the thread.</span>
                <span class="k">raise</span> <span class="n">e</span>
            <span class="c1"># If policy is OVERWRITE, the exception is handled inside push() and not raised.</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># After a broadcast from a source, the event is always consumed</span>
            <span class="c1"># from the source queue, even if the transfer failed. This prevents</span>
            <span class="c1"># the downstream part from re-triggering the transfer.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__output_queue</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_register_wakeup_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">part</span><span class="p">:</span> <span class="n">Part</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Links this source to a part&#39;s wakeup signal.</span>

<span class="sd">        Args:</span>
<span class="sd">            part (Part): The part whose wakeup signal should be set on emit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__part_wakeup_signal</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">_get_wakeup_signal</span><span class="p">()</span></div>



<div class="viewcode-block" id="Interface">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Interface">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Interface</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a connection between two ports, a master and a slave.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">master_port</span><span class="p">:</span> <span class="n">Port</span><span class="p">,</span> <span class="n">slave_port</span><span class="p">:</span> <span class="n">Port</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes an Interface.</span>

<span class="sd">        Args:</span>
<span class="sd">            master_port: The source port for the data transfer.</span>
<span class="sd">            slave_port: The destination port for the data transfer.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the port connection is invalid according to the framework rules.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">master_port</span><span class="o">.</span><span class="n">get_direction</span><span class="p">()</span> <span class="o">==</span> <span class="n">Port</span><span class="o">.</span><span class="n">OUT</span> <span class="ow">and</span> <span class="n">slave_port</span><span class="o">.</span><span class="n">get_direction</span><span class="p">()</span> <span class="o">==</span> <span class="n">Port</span><span class="o">.</span><span class="n">IN</span><span class="p">)</span> <span class="ow">and</span> \
           <span class="ow">not</span> <span class="p">(</span><span class="n">master_port</span><span class="o">.</span><span class="n">get_direction</span><span class="p">()</span> <span class="o">==</span> <span class="n">slave_port</span><span class="o">.</span><span class="n">get_direction</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">ERROR_INVALID_INTERFACE_CONNECTION</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">master_port</span><span class="o">.</span><span class="n">get_direction</span><span class="p">(),</span> <span class="n">slave_port</span><span class="o">.</span><span class="n">get_direction</span><span class="p">()))</span>
        
        <span class="n">slave_port</span><span class="o">.</span><span class="n">_set_connected_as_slave</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__master_port</span> <span class="o">=</span> <span class="n">master_port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__slave_port</span> <span class="o">=</span> <span class="n">slave_port</span>

<div class="viewcode-block" id="Interface.get_identifier">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Interface.get_identifier">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the identifier for this interface.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The fully qualified connection string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">()</span></div>


<div class="viewcode-block" id="Interface.get_full_identifier">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Interface.get_full_identifier">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_full_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dynamically generates the identifier string for this interface.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The fully qualified connection string (e.g., &quot;part.out-&gt;part2.in&quot;).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">CONNECTION_FORMAT</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">master_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__master_port</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span>
            <span class="n">slave_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__slave_port</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">()</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Interface.get_master_port">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Interface.get_master_port">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_master_port</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Port</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the master (source) port of the interface.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Port: The master port instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__master_port</span></div>

    
<div class="viewcode-block" id="Interface.get_slave_port">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Interface.get_slave_port">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_slave_port</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Port</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the slave (destination) port of the interface.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Port: The slave port instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__slave_port</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_transfer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transfers payload from the master port to the slave port if updated.</span>
<span class="sd">        </span>
<span class="sd">        NOTE: This method does NOT clear the master port&#39;s update flag.</span>
<span class="sd">        The caller is responsible for clearing the flag after all transfers</span>
<span class="sd">        for a given port are complete to enable one-to-many connections.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__master_port</span><span class="o">.</span><span class="n">is_updated</span><span class="p">():</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__master_port</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_DATAFLOW</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_TRANSFER</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;payload&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__slave_port</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></div>


<div class="viewcode-block" id="EventInterface">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.EventInterface">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">EventInterface</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a connection between two event queues.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">master_queue</span><span class="p">:</span> <span class="n">EventQueue</span><span class="p">,</span> <span class="n">slave_queue</span><span class="p">:</span> <span class="n">EventQueue</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes an EventInterface.</span>

<span class="sd">        Args:</span>
<span class="sd">            master_queue: The source queue for the event transfer.</span>
<span class="sd">            slave_queue: The destination queue for the event transfer.</span>
<span class="sd">        </span>
<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the queue connection is invalid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">master_queue</span><span class="o">.</span><span class="n">get_direction</span><span class="p">()</span> <span class="o">==</span> <span class="n">EventQueue</span><span class="o">.</span><span class="n">OUT</span> <span class="ow">and</span> <span class="n">slave_queue</span><span class="o">.</span><span class="n">get_direction</span><span class="p">()</span> <span class="o">==</span> <span class="n">EventQueue</span><span class="o">.</span><span class="n">IN</span><span class="p">)</span> <span class="ow">and</span> \
           <span class="ow">not</span> <span class="p">(</span><span class="n">master_queue</span><span class="o">.</span><span class="n">get_direction</span><span class="p">()</span> <span class="o">==</span> <span class="n">EventQueue</span><span class="o">.</span><span class="n">IN</span> <span class="ow">and</span> <span class="n">slave_queue</span><span class="o">.</span><span class="n">get_direction</span><span class="p">()</span> <span class="o">==</span> <span class="n">EventQueue</span><span class="o">.</span><span class="n">IN</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">ERROR_INVALID_EVENT_INTERFACE_CONNECTION</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">master_queue</span><span class="o">.</span><span class="n">get_direction</span><span class="p">(),</span> <span class="n">slave_queue</span><span class="o">.</span><span class="n">get_direction</span><span class="p">()))</span>

        <span class="n">master_queue</span><span class="o">.</span><span class="n">_set_connected_as_master</span><span class="p">()</span>
        <span class="n">slave_queue</span><span class="o">.</span><span class="n">_set_connected_as_slave</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__master_queue</span> <span class="o">=</span> <span class="n">master_queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__slave_queue</span> <span class="o">=</span> <span class="n">slave_queue</span>
        <span class="c1"># Register this interface with the master queue so it can trigger transfers.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__master_queue</span><span class="o">.</span><span class="n">_add_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="EventInterface.get_identifier">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.EventInterface.get_identifier">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the identifier for this event interface.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The fully qualified connection string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">()</span></div>


<div class="viewcode-block" id="EventInterface.get_full_identifier">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.EventInterface.get_full_identifier">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_full_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dynamically generates the identifier string for this event interface.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The fully qualified connection string (e.g., &quot;part.q_out-&gt;part2.q_in&quot;).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">CONNECTION_FORMAT</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">master_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__master_queue</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span>
            <span class="n">slave_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__slave_queue</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">()</span>
        <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_transfer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transfers an event from the master to the slave queue.</span>

<span class="sd">        - For OUT -&gt; IN (broadcast), the event is copied.</span>
<span class="sd">        - For IN -&gt; IN (routing), the event is moved.</span>

<span class="sd">        Args:</span>
<span class="sd">            overwrite (bool): If True, the transfer to the slave queue will</span>
<span class="sd">                              overwrite an existing item if the queue is full.</span>
<span class="sd">                              This is only applicable for OUT -&gt; IN transfers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__master_queue</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="c1"># Broadcast from a source (OUT-&gt;IN) is a non-destructive copy.</span>
        <span class="c1"># The EventSource is responsible for clearing its queue after the emit.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__master_queue</span><span class="o">.</span><span class="n">get_direction</span><span class="p">()</span> <span class="o">==</span> <span class="n">EventQueue</span><span class="o">.</span><span class="n">OUT</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__master_queue</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span>
            <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_DATAFLOW</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_TRANSFER_BROADCAST</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;payload&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">})</span>
            <span class="c1"># By removing the is_full() check, this line is now allowed to fail</span>
            <span class="c1"># and raise an EventQueue.FullError, which will be caught by the</span>
            <span class="c1"># EventSource&#39;s robust exception handler.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__slave_queue</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
        <span class="c1"># Routing between parts (IN-&gt;IN) is a destructive move.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__slave_queue</span><span class="o">.</span><span class="n">is_full</span><span class="p">():</span>
                <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_EXECUTION</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_TRANSFER_SKIPPED</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_DETAIL_REASON_SLAVE_FULL</span><span class="p">})</span>
                <span class="k">return</span>  <span class="c1"># The event remains in the master queue and the transfer is skipped.</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__master_queue</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_DATAFLOW</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_TRANSFER_ROUTE</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;payload&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__slave_queue</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></div>



<div class="viewcode-block" id="Part">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Part">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Part</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a component in the system.</span>

<span class="sd">    A Part can be structural (composed of other parts) or behavioral</span>
<span class="sd">    (defined by a Python method).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">STRUCTURAL</span> <span class="o">=</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">COMPONENT_TYPE_STRUCTURAL</span>
    <span class="n">BEHAVIORAL</span> <span class="o">=</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">COMPONENT_TYPE_BEHAVIORAL</span>

<div class="viewcode-block" id="Part.NotExecutableError">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Part.NotExecutableError">[docs]</a>
    <span class="k">class</span><span class="w"> </span><span class="nc">NotExecutableError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Exception raised when the main run loop is attempted on a behavioral part.</span>
<span class="sd">        The simulation loop can only be started on structural parts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="Part.BehaviorNotAllowedError">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Part.BehaviorNotAllowedError">[docs]</a>
    <span class="k">class</span><span class="w"> </span><span class="nc">BehaviorNotAllowedError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Exception raised when behavior() is called on a structural part.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="Part.get_identifier">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Part.get_identifier">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the local identifier of the part.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The local identifier of the part.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__identifier</span></div>


<div class="viewcode-block" id="Part.get_full_identifier">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Part.get_full_identifier">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_full_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the fully qualified identifier of the part.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The fully qualified identifier, including parent hierarchy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__full_identifier</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">execution_strategy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Set</span><span class="p">[</span><span class="n">Part</span><span class="p">]],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">ports</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Port</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">parts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Part</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">event_queues</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">EventQueue</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">scheduling_condition</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Part</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">conf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes a Part.</span>

<span class="sd">        Args:</span>
<span class="sd">            identifier: A unique name for the part.</span>
<span class="sd">            execution_strategy: The strategy to execute inner parts (for structural parts).</span>
<span class="sd">            ports: A list of ports for this part.</span>
<span class="sd">            parts: A dictionary of inner parts, keyed by their identifier.</span>
<span class="sd">            event_queues: A list of event queues for this part.</span>
<span class="sd">            scheduling_condition: An optional callable that returns True if the part</span>
<span class="sd">                                  should be scheduled for execution. If not provided,</span>
<span class="sd">                                  a default condition is used.</span>
<span class="sd">            conf: An optional configuration object to be passed down the hierarchy.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the configuration is inconsistent (e.g., providing an</span>
<span class="sd">                        execution_strategy for a behavioral part, or not providing</span>
<span class="sd">                        one for a structural part).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__identifier</span> <span class="o">=</span> <span class="n">identifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__full_identifier</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__identifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Part</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__wakeup_signal</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__exception</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="ne">Exception</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__creation_logged</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__scheduling_condition</span> <span class="o">=</span> <span class="n">scheduling_condition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conf</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Will be set by self.configure()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tick</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__hooks</span> <span class="o">=</span> <span class="p">{</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">HOOK_TYPE_INIT</span><span class="p">:</span> <span class="p">[],</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">HOOK_TYPE_TERM</span><span class="p">:</span> <span class="p">[]}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__ports</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">ports</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__ports</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">get_identifier</span><span class="p">()]</span> <span class="o">=</span> <span class="n">p</span>
                <span class="n">p</span><span class="o">.</span><span class="n">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__parts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">parts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__parts</span> <span class="o">=</span> <span class="n">parts</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parts</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">p</span><span class="o">.</span><span class="n">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__interfaces</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Interface</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__event_interfaces</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">EventInterface</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__event_queues</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">event_queues</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">event_queues</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">get_direction</span><span class="p">()</span> <span class="o">!=</span> <span class="n">EventQueue</span><span class="o">.</span><span class="n">IN</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">ERROR_PART_CAN_ONLY_HAVE_INPUT_QUEUES</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_identifier</span><span class="p">()))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__event_queues</span><span class="p">[</span><span class="n">q</span><span class="o">.</span><span class="n">get_identifier</span><span class="p">()]</span> <span class="o">=</span> <span class="n">q</span>
                <span class="n">q</span><span class="o">.</span><span class="n">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">parts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__description</span> <span class="o">=</span> <span class="n">Part</span><span class="o">.</span><span class="n">STRUCTURAL</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">behavior</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Part</span><span class="o">.</span><span class="n">behavior</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">ERROR_STRUCTURAL_PART_OVERRIDES_BEHAVIOR</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">execution_strategy</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">ERROR_STRUCTURAL_PART_MISSING_EXECUTION_STRATEGY</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__execution_strategy</span> <span class="o">=</span> <span class="n">execution_strategy</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__is_running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__description</span> <span class="o">=</span> <span class="n">Part</span><span class="o">.</span><span class="n">BEHAVIORAL</span>
            <span class="k">if</span> <span class="n">execution_strategy</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">ERROR_BEHAVIORAL_PART_WITH_EXECUTION_STRATEGY</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__execution_strategy</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># After all internal structures are set up, apply the configuration.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">Part</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the parent component and trigger a cascading name update.</span>

<span class="sd">        This is called during the parent&#39;s initialization to establish the</span>
<span class="sd">        hierarchical structure and enable full identifier generation.</span>

<span class="sd">        Args:</span>
<span class="sd">            parent (Part): The parent Part object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parent</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># Parent already set.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_full_identifier</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_full_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates the full identifier and cascade the update to children.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parent</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__full_identifier</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__parent</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">()</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_identifier</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__ports</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__parts</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__event_queues</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">component</span><span class="o">.</span><span class="n">_update_full_identifier</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_log_creation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Logs the creation of this part and cascades the call to its children.&quot;&quot;&quot;</span>
        <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_CREATE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_CREATE</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__description</span><span class="p">})</span>
        <span class="c1"># Log child components first for a more intuitive order in the log file.</span>
        <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__ports</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__event_queues</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">component</span><span class="o">.</span><span class="n">_log_creation</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parts</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">part</span><span class="o">.</span><span class="n">_log_creation</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_transfer_and_clear_ports</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles the one-to-many transfer logic for all data ports.</span>
<span class="sd">        It transfers data from all updated master ports to their slaves,</span>
<span class="sd">        and then clears the update flags on those master ports.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_EXECUTION</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_TRANSFER_PORTS</span><span class="p">)</span>
        <span class="n">master_ports_to_interfaces</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">interface</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__interfaces</span><span class="p">:</span>
            <span class="n">master_port</span> <span class="o">=</span> <span class="n">interface</span><span class="o">.</span><span class="n">get_master_port</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">master_port</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">master_ports_to_interfaces</span><span class="p">:</span>
                <span class="n">master_ports_to_interfaces</span><span class="p">[</span><span class="n">master_port</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">master_ports_to_interfaces</span><span class="p">[</span><span class="n">master_port</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interface</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">master_port</span><span class="p">,</span> <span class="n">interfaces</span> <span class="ow">in</span> <span class="n">master_ports_to_interfaces</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">master_port</span><span class="o">.</span><span class="n">is_updated</span><span class="p">():</span>
                <span class="c1"># Transfer to all slave ports first</span>
                <span class="k">for</span> <span class="n">interface</span> <span class="ow">in</span> <span class="n">interfaces</span><span class="p">:</span>
                    <span class="n">interface</span><span class="o">.</span><span class="n">_transfer</span><span class="p">()</span>
                <span class="c1"># Then clear the master flag once all slaves have the data</span>
                <span class="n">master_port</span><span class="o">.</span><span class="n">_clear_update_flag</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_wakeup_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the part&#39;s threading.Event object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            threading.Event: The event object used to wake up the part&#39;s run loop.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__wakeup_signal</span>

<div class="viewcode-block" id="Part.connect">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Part.connect">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">master_port</span><span class="p">:</span> <span class="n">Port</span><span class="p">,</span> <span class="n">slave_port</span><span class="p">:</span> <span class="n">Port</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Connects two ports, creating an interface.</span>

<span class="sd">        Args:</span>
<span class="sd">            master_port (Port): The source port for the data transfer.</span>
<span class="sd">            slave_port (Port): The destination port for the data transfer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">interface</span> <span class="o">=</span> <span class="n">Interface</span><span class="p">(</span><span class="n">master_port</span><span class="p">,</span> <span class="n">slave_port</span><span class="p">)</span>
        <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_CONNECT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_CONNECT_PORT</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;master&quot;</span><span class="p">:</span> <span class="n">master_port</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="s2">&quot;slave&quot;</span><span class="p">:</span> <span class="n">slave_port</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">()})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__interfaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interface</span><span class="p">)</span></div>


<div class="viewcode-block" id="Part.connect_event_source">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Part.connect_event_source">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">connect_event_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="n">EventSource</span><span class="p">,</span> <span class="n">target_queue_identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Connects an external event source to one of this part&#39;s input queues.</span>

<span class="sd">        This establishes both the data path (via an EventInterface) and the</span>
<span class="sd">        synchronization signal for waking up the part&#39;s run loop.</span>

<span class="sd">        Args:</span>
<span class="sd">            source (EventSource): The EventSource to connect.</span>
<span class="sd">            target_queue_identifier (str): The identifier of the target input</span>
<span class="sd">                                           queue on this part.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">target_queue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_event_queue</span><span class="p">(</span><span class="n">target_queue_identifier</span><span class="p">)</span>
        <span class="n">source</span><span class="o">.</span><span class="n">_register_wakeup_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect_event_queue</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">_get_output_queue</span><span class="p">(),</span> <span class="n">target_queue</span><span class="p">)</span>
        <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_CONNECT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_CONNECT_EVENT_SRC</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">source</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="s2">&quot;target_queue&quot;</span><span class="p">:</span> <span class="n">target_queue</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">()})</span></div>


<div class="viewcode-block" id="Part.connect_event_queue">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Part.connect_event_queue">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">connect_event_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">master_queue</span><span class="p">:</span> <span class="n">EventQueue</span><span class="p">,</span> <span class="n">slave_queue</span><span class="p">:</span> <span class="n">EventQueue</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Connects an event source or a parent queue to a child queue.</span>

<span class="sd">        Args:</span>
<span class="sd">            master_queue (EventQueue): The source queue for the event transfer.</span>
<span class="sd">            slave_queue (EventQueue): The destination queue for the event transfer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The slave queue must belong either to this part or one of its direct inner parts.</span>
        <span class="n">is_own_queue</span> <span class="o">=</span> <span class="n">slave_queue</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__event_queues</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

        <span class="n">is_inner_part_queue</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_own_queue</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parts</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Check if the inner part has the queue and it&#39;s the correct object</span>
                    <span class="k">if</span> <span class="n">part</span><span class="o">.</span><span class="n">get_event_queue</span><span class="p">(</span><span class="n">slave_queue</span><span class="o">.</span><span class="n">get_identifier</span><span class="p">())</span> <span class="ow">is</span> <span class="n">slave_queue</span><span class="p">:</span>
                        <span class="n">is_inner_part_queue</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="c1"># This inner part doesn&#39;t have a queue with that name, so we continue</span>
                    <span class="k">continue</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_own_queue</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_inner_part_queue</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">ERROR_SLAVE_EVENT_QUEUE_NOT_IN_PART</span><span class="p">)</span>

        <span class="n">interface</span> <span class="o">=</span> <span class="n">EventInterface</span><span class="p">(</span><span class="n">master_queue</span><span class="p">,</span> <span class="n">slave_queue</span><span class="p">)</span>
        <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_CONNECT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_CONNECT_EVENT_Q</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;master&quot;</span><span class="p">:</span> <span class="n">master_queue</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="s2">&quot;slave&quot;</span><span class="p">:</span> <span class="n">slave_queue</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">()})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__event_interfaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interface</span><span class="p">)</span></div>


<div class="viewcode-block" id="Part.get_event_queue">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Part.get_event_queue">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_event_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EventQueue</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves an event queue by its identifier.</span>

<span class="sd">        Args:</span>
<span class="sd">            identifier (str): The name of the event queue to retrieve.</span>

<span class="sd">        Returns:</span>
<span class="sd">            EventQueue: The requested event queue instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__event_queues</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">ERROR_EVENT_QUEUE_NOT_FOUND</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">()))</span></div>


<div class="viewcode-block" id="Part.get_port">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Part.get_port">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_port</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Port</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves a port by its identifier.</span>

<span class="sd">        Args:</span>
<span class="sd">            identifier (str): The name of the port to retrieve.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Port: The requested port instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ports</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">ERROR_PORT_NOT_FOUND</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">()))</span></div>


<div class="viewcode-block" id="Part.get_ports">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Part.get_ports">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_ports</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Port</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves all ports of a given direction.</span>

<span class="sd">        Args:</span>
<span class="sd">            direction (str): The direction of ports to retrieve (Port.IN or Port.OUT).</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Port]: A list of ports matching the given direction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Port</span><span class="o">.</span><span class="n">IN</span><span class="p">,</span> <span class="n">Port</span><span class="o">.</span><span class="n">OUT</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">ERROR_INVALID_PORT_DIRECTION</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">direction</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ports</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">get_direction</span><span class="p">()</span> <span class="o">==</span> <span class="n">direction</span><span class="p">]</span></div>


<div class="viewcode-block" id="Part.get_part">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Part.get_part">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_part</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Part</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves an inner part by its identifier.</span>

<span class="sd">        Args:</span>
<span class="sd">            identifier (str): The name of the inner part to retrieve.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Part: The requested inner part instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parts</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">ERROR_PART_NOT_FOUND</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">()))</span></div>


<div class="viewcode-block" id="Part.get_parts">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Part.get_parts">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_parts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Part</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves all inner parts of this structural part.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Part]: A list of all inner part instances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__parts</span><span class="o">.</span><span class="n">values</span><span class="p">())</span></div>


<div class="viewcode-block" id="Part.get_event_queues">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Part.get_event_queues">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_event_queues</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">EventQueue</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves all event queues of this part.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[EventQueue]: A list of all event queue instances belonging to this part.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__event_queues</span><span class="o">.</span><span class="n">values</span><span class="p">())</span></div>


<div class="viewcode-block" id="Part.get_interfaces">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Part.get_interfaces">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_interfaces</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Interface</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves all data port interfaces (connections) of this structural part.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Interface]: A list of all interface instances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__interfaces</span></div>


<div class="viewcode-block" id="Part.get_exception">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Part.get_exception">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="ne">Exception</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the exception that caused the run loop to terminate, if any.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[Exception]: The exception object if one occurred, otherwise None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__exception</span></div>


<div class="viewcode-block" id="Part.configure">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Part.configure">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recursively configures the part and all its sub-parts.</span>

<span class="sd">        The default behavior is to store the configuration object and pass it</span>
<span class="sd">        down to all children. This method can be overridden by subclasses for</span>
<span class="sd">        custom configuration logic.</span>

<span class="sd">        Args:</span>
<span class="sd">            conf: The configuration object to apply.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conf</span> <span class="o">=</span> <span class="n">conf</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parts</span><span class="p">():</span>
                <span class="n">part</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="p">)</span></div>


<div class="viewcode-block" id="Part.add_hook">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Part.add_hook">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hook_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Registers a function to be called at a specific lifecycle event.</span>

<span class="sd">        This is useful for setting up or tearing down resources that are</span>
<span class="sd">        external to the simulation framework&#39;s core logic, such as</span>
<span class="sd">        connecting to a physics engine or closing plot windows.</span>

<span class="sd">        Args:</span>
<span class="sd">            hook_type: The type of hook, either &#39;init&#39; or &#39;term&#39;.</span>
<span class="sd">            func: The function to register.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">hook_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">VALID_HOOK_TYPES</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">ERROR_INVALID_HOOK_TYPE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hook_type</span><span class="p">))</span>
        <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_LIFECYCLE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_ADD_HOOK</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">hook_type</span><span class="p">,</span> <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__hooks</span><span class="p">[</span><span class="n">hook_type</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">)</span></div>


<div class="viewcode-block" id="Part.init">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Part.init">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recursively initializes the part and all its sub-parts.</span>

<span class="sd">        This method should be called once on the top-level part before starting</span>
<span class="sd">        the simulation. It executes all registered &#39;init&#39; hooks in a top-down</span>
<span class="sd">        manner.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_LIFECYCLE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_INIT_START</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__hooks</span><span class="p">[</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">HOOK_TYPE_INIT</span><span class="p">]:</span>
            <span class="n">hook</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parts</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">part</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
        <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_LIFECYCLE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_INIT_END</span><span class="p">)</span></div>


<div class="viewcode-block" id="Part.term">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Part.term">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">term</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recursively terminates the part and all its sub-parts.</span>

<span class="sd">        This method should be called once on the top-level part after the</span>
<span class="sd">        simulation has finished. It executes all registered &#39;term&#39; hooks in a</span>
<span class="sd">        top-down manner.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_LIFECYCLE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_TERM_START</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__hooks</span><span class="p">[</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">HOOK_TYPE_TERM</span><span class="p">]:</span>
            <span class="n">hook</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parts</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">part</span><span class="o">.</span><span class="n">term</span><span class="p">()</span>
        <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_LIFECYCLE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_TERM_END</span><span class="p">)</span></div>


<div class="viewcode-block" id="Part.behavior">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Part.behavior">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">behavior</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Defines the behavior of the part.</span>

<span class="sd">        This method should be overridden by subclasses of behavioral parts.</span>

<span class="sd">        Raises:</span>
<span class="sd">            BehaviorNotAllowedError: If this part is structural.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__description</span> <span class="o">==</span> <span class="n">Part</span><span class="o">.</span><span class="n">STRUCTURAL</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">BehaviorNotAllowedError</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">ERROR_BEHAVIOR_ON_STRUCTURAL_PART</span><span class="p">)</span></div>

        <span class="c1"># This method is intended to be overridden by behavioral part subclasses.</span>
        <span class="c1"># The base implementation does nothing.</span>

<div class="viewcode-block" id="Part.trace_log">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Part.trace_log">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">trace_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">details</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Logs a custom message to the global tracer from within a part&#39;s behavior.</span>

<span class="sd">        This is the recommended way for user-defined parts to create trace output.</span>

<span class="sd">        Args:</span>
<span class="sd">            message (str): The string message to log.</span>
<span class="sd">            details (Optional[dict]): An optional dictionary of key-value pairs</span>
<span class="sd">                                      for structured data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">LogLevel</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">conf</span><span class="o">.</span><span class="n">LOG_EVENT_USER_LOG</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">details</span> <span class="ow">or</span> <span class="p">{})})</span></div>

 
    <span class="k">def</span><span class="w"> </span><span class="nf">__wait_for_events</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Blocks execution until an event is present in an input queue.</span>

<span class="sd">        If an event is already in one of the queues, it returns immediately.</span>
<span class="sd">        Otherwise, it waits for a signal from a connected `EventSource`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># First, check if an event is already present.</span>
        <span class="k">for</span> <span class="n">queue</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_event_queues</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">queue</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_EXECUTION</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_WAIT_SKIPPED</span><span class="p">)</span>
                <span class="k">return</span>  <span class="c1"># Event found, no need to wait.</span>

        <span class="c1"># If no events are present, wait for the signal.</span>
        <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_EXECUTION</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_WAIT_START</span><span class="p">,</span> <span class="n">tick</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tick</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__wakeup_signal</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__wakeup_signal</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>  <span class="c1"># Reset for the next wait cycle.</span>
        <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_EXECUTION</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_WAIT_END</span><span class="p">,</span> <span class="n">tick</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tick</span><span class="p">)</span>
 
<div class="viewcode-block" id="Part.start">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Part.start">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stop_condition</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Part</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starts the part&#39;s run loop in a new thread.</span>

<span class="sd">        This method is only applicable to structural parts.</span>

<span class="sd">        Args:</span>
<span class="sd">            stop_condition: A callable that returns True to stop the loop.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotExecutableError: If called on a behavioral part.</span>
<span class="sd">            RuntimeError: If the part is already running.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__description</span> <span class="o">!=</span> <span class="n">Part</span><span class="o">.</span><span class="n">STRUCTURAL</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">NotExecutableError</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">ERROR_START_ON_BEHAVIORAL_PART</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_running</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">ERROR_PART_ALREADY_RUNNING</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">()))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__creation_logged</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_creation</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__creation_logged</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__is_running</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">stop_condition</span><span class="p">,),</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">()</span><span class="si">}{</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">THREAD_NAME_SUFFIX</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>


<div class="viewcode-block" id="Part.wait">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Part.wait">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Waits for the part&#39;s run thread to complete.</span>

<span class="sd">        Args:</span>
<span class="sd">            timeout (Optional[float]): The maximum time in seconds to wait</span>
<span class="sd">                                       for the thread to complete.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__is_running</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Part.is_running">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Part.is_running">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_running</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if the part&#39;s execution thread is currently running.</span>

<span class="sd">        This is only applicable for structural parts that have been started.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the thread exists and is running, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_is_executable</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if the part is ready to be executed by its parent.</span>

<span class="sd">        If a `scheduling_condition` was provided during initialization, it is</span>
<span class="sd">        used. Otherwise, the default behavior is to consider the part executable</span>
<span class="sd">        if any of its input ports have been updated or any of its input event</span>
<span class="sd">        queues contain an event.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the part should be scheduled for execution, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__scheduling_condition</span><span class="p">:</span>
            <span class="c1"># If a specific condition is provided, use it regardless of part type.</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__scheduling_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Default scheduling condition: executable if any input is present.</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_updated</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ports</span><span class="p">(</span><span class="n">Port</span><span class="o">.</span><span class="n">IN</span><span class="p">)):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="n">q</span><span class="o">.</span><span class="n">is_empty</span><span class="p">()</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_event_queues</span><span class="p">()):</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs one cycle of scheduling and execution of inner parts.</span>
<span class="sd">        This method iteratively schedules and executes children as long as there is</span>
<span class="sd">        data flowing between them, ensuring that dependencies are resolved within</span>
<span class="sd">        a single step of the parent part.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the system was idle (no parts were scheduled), False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_EXECUTION</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_STEP_START</span><span class="p">,</span> <span class="n">tick</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tick</span><span class="p">)</span>
        <span class="n">has_executed_anything_in_this_step</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Determine which children need to be executed in this sub-step.</span>
            <span class="c1"># Pass down the tick value to all children before scheduling.</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parts</span><span class="p">():</span>
                <span class="n">child</span><span class="o">.</span><span class="n">tick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tick</span>

            <span class="n">to_be_scheduled</span> <span class="o">=</span> <span class="p">{</span><span class="n">child</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parts</span><span class="p">()</span> <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">_is_executable</span><span class="p">()}</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">to_be_scheduled</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">has_executed_anything_in_this_step</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">scheduled_part_ids</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">to_be_scheduled</span><span class="p">}</span>
            <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_EXECUTION</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_STEP_SCHEDULE</span><span class="p">,</span> <span class="p">{</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_DETAIL_KEY_SCHEDULED</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">scheduled_part_ids</span><span class="p">))})</span>
            
            <span class="c1"># The engine is responsible for logging the strategy&#39;s boundaries.</span>
            <span class="n">strategy_event</span> <span class="o">=</span> <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_EXECUTION</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_EXECUTION_STRATEGY_START</span><span class="p">,</span> <span class="p">{</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_DETAIL_KEY_STRATEGY</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__execution_strategy</span><span class="o">.</span><span class="vm">__name__</span><span class="p">},</span> <span class="n">tick</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tick</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__execution_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to_be_scheduled</span><span class="p">,</span> <span class="n">strategy_event</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_and_clear_ports</span><span class="p">()</span>
            <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_EXECUTION</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_EXECUTION_STRATEGY_END</span><span class="p">,</span> <span class="p">{</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_DETAIL_KEY_STRATEGY</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__execution_strategy</span><span class="o">.</span><span class="vm">__name__</span><span class="p">},</span> <span class="n">tick</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tick</span><span class="p">)</span>
        <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_EXECUTION</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_STEP_END</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;idle&quot;</span><span class="p">:</span> <span class="ow">not</span> <span class="n">has_executed_anything_in_this_step</span><span class="p">},</span> <span class="n">tick</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tick</span><span class="p">)</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">has_executed_anything_in_this_step</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stop_condition</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Part</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The internal execution loop for a structural part, run in a separate thread.</span>

<span class="sd">        This method is started via the public `start()` method and should not be</span>
<span class="sd">        called directly.</span>

<span class="sd">        Args:</span>
<span class="sd">            stop_condition (Callable[[Part], bool]): A callable that takes the</span>
<span class="sd">                part instance and returns True to stop the loop.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Set thread-local settings.</span>
            <span class="n">data</span><span class="o">.</span><span class="n">set_context</span><span class="p">()</span>

            <span class="c1"># Initialize tick counter for the top-level simulation loop.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__description</span> <span class="o">==</span> <span class="n">Part</span><span class="o">.</span><span class="n">STRUCTURAL</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tick</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_LIFECYCLE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_LIFECYCLE_THREAD_START</span><span class="p">,</span> <span class="n">tick</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tick</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__description</span> <span class="o">!=</span> <span class="n">Part</span><span class="o">.</span><span class="n">STRUCTURAL</span><span class="p">:</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">NotExecutableError</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">ERROR__RUN_ON_BEHAVIORAL_PART</span><span class="p">)</span>

            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">stop_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                    <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_LIFECYCLE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_STOP_CONDITION_MET</span><span class="p">)</span>
                    <span class="k">break</span>

                <span class="n">is_idle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__step</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">is_idle</span><span class="p">:</span>
                    <span class="c1"># No parts were scheduled, check if we should terminate or wait for events.</span>
                    <span class="k">if</span> <span class="n">stop_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                        <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_LIFECYCLE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_STOP_CONDITION_MET_IDLE</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__wait_for_events</span><span class="p">()</span>
                        <span class="c1"># After waking up, transfer the captured events to inner parts</span>
                        <span class="c1"># and increment the tick counter.</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tick</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">tick</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_EXECUTION</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_WAKEUP_TRANSFER</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">event_interface</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__event_interfaces</span><span class="p">:</span>
                            <span class="n">event_interface</span><span class="o">.</span><span class="n">_transfer</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1"># Catches all exceptions from the execution loop</span>
            <span class="n">tb_str</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">LogLevel</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_EXCEPTION</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="s2">&quot;traceback&quot;</span><span class="p">:</span> <span class="n">tb_str</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__exception</span> <span class="o">=</span> <span class="n">e</span>
            <span class="c1"># Do not re-raise, to be consistent with EventSource exception handling.</span>
        <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_LIFECYCLE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_LIFECYCLE_THREAD_END</span><span class="p">,</span> <span class="n">tick</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tick</span><span class="p">)</span>

<div class="viewcode-block" id="Part.execute">
<a class="viewcode-back" href="../../engine_api.html#ml.engine.Part.execute">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes a single cycle of the part.</span>
<span class="sd">        For structural parts, it propagates inputs and runs the inner loop once.</span>
<span class="sd">        For behavioral parts, it calls the behavior() method.</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parent</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parent</span><span class="o">.</span><span class="n">tick</span>

        <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_EXECUTION</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_EXECUTION_START</span><span class="p">,</span> <span class="p">{</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_DETAIL_KEY_TICK</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tick</span><span class="p">})</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__description</span> <span class="o">==</span> <span class="n">Part</span><span class="o">.</span><span class="n">STRUCTURAL</span><span class="p">:</span>
            <span class="c1"># For a structural part, execution involves three stages:</span>
            <span class="c1"># 1. Propagate incoming events from parent queues to child queues.            </span>
            <span class="k">for</span> <span class="n">event_interface</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__event_interfaces</span><span class="p">:</span>
                <span class="n">event_interface</span><span class="o">.</span><span class="n">_transfer</span><span class="p">()</span>

            <span class="c1"># 2. Propagate data from this part&#39;s own input ports to its children&#39;s ports.</span>
            <span class="c1"># This handles the IN -&gt; IN connections at the boundary.</span>
            <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ports</span><span class="p">(</span><span class="n">Port</span><span class="o">.</span><span class="n">IN</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">port</span><span class="o">.</span><span class="n">is_updated</span><span class="p">():</span>
                    <span class="c1"># Find all interfaces starting from this port and transfer.</span>
                    <span class="k">for</span> <span class="n">interface</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__interfaces</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">interface</span><span class="o">.</span><span class="n">get_master_port</span><span class="p">()</span> <span class="ow">is</span> <span class="n">port</span><span class="p">:</span>
                            <span class="n">interface</span><span class="o">.</span><span class="n">_transfer</span><span class="p">()</span>
                    <span class="c1"># After propagating to all children, clear the flag on this input port</span>
                    <span class="c1"># to signify it has been consumed at this level.</span>
                    <span class="n">port</span><span class="o">.</span><span class="n">_clear_update_flag</span><span class="p">()</span>

            <span class="c1"># 3. Run one cycle of its internal scheduling and execution.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__step</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Behavioral</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">behavior</span><span class="p">()</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="c1"># After a behavioral part&#39;s behavior() method completes, its</span>
                <span class="c1"># inputs are considered consumed. The framework clears the flags</span>
                <span class="c1"># on all input ports to prevent the part from being re-scheduled</span>
                <span class="c1"># infinitely on the same data.</span>
                <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ports</span><span class="p">(</span><span class="n">Port</span><span class="o">.</span><span class="n">IN</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">port</span><span class="o">.</span><span class="n">is_updated</span><span class="p">():</span>
                        <span class="n">port</span><span class="o">.</span><span class="n">_clear_update_flag</span><span class="p">()</span>
        <span class="n">Tracer</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_LEVEL_EXECUTION</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_identifier</span><span class="p">(),</span> <span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_EVENT_EXECUTION_END</span><span class="p">,</span> <span class="p">{</span><span class="n">ml_conf</span><span class="o">.</span><span class="n">LOG_DETAIL_KEY_TICK</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tick</span><span class="p">})</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>